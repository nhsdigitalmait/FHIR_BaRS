#
# BaRS_CancelAppointment tstp file Use Case 111 to ED
#
# slot numbers refer to test scenario identifiers not actual slot numbers
#
SCRIPT BaRS_CancelAppointment

BEGIN SCHEDULES
ReadNonExistentAppointment TESTS ReadNonExistentAppointment ResponseIsOperationOutcome 
#OperationOutcomeSystemCodeIsSpine NoRecordFound

# happy path
CancelAppointment_HappyPath TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ReadAppointment1 CancelAppointment_HappyPath1 ResponseIsAppointment IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch

CancelAppointment_DifferencesDetected TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ReadAppointment1 CancelAppointment_DifferencesDetected ResponseIsOperationOutcome 
#OperationOutcomeSystemCodeIsSpine ReferenceNotFound


#
END SCHEDULES

BEGIN TESTS

ReadNonExistentAppointment SEND_TKW empty_file TO __TO_ENDPOINT__/Appointment/95e58add-0b10-4a8c-817c-2729eb0cab75 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck404 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+xml_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 404"

ReadAppointment1 SEND_TKW empty_file1 TO __TO_ENDPOINT__/Appointment/__APPT_ID__ FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC ok WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 200"

#============================================================================================================

# Happy path scenario 22
CancelAppointment_HappyPath1 SEND_TKW cancel_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_appointment.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200 SCAL P-CAN-APP-RET-OK-CODE-LAST-MOD-ETAG-HEAD-VERS-ID"

# scenario 23
CancelAppointment_DifferencesDetected SEND_TKW cancel_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/change_patient_surname.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck422 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 422"


#============================================================================================================

ResponseIsAppointment CHAIN SYNC response_is_appt TEXT "Response contains a root fhir:Appointment element"
END TESTS

BEGIN MESSAGES
cancel_appointment_slot1 USING cancel_appt_template WITH slots1_ds ID s1
END MESSAGES

BEGIN PASSFAIL
#
# Response checks
#
response_is_appt synchronousxpath /fhir:Bundle/fhir:entry/fhir:resource/fhir:Appointment exists

httpheadercheckcontentlengthexists httpheadercheck Content-Length exists
last_modified_header_is_present httpheadercheck Last-Modified exists
END PASSFAIL
