#
# BaRS_BookAppointment tstp file Use Case 111 to ED
# slot numbers refer to test scenario identifiers not actual slot numbers
#
SCRIPT BaRS_BookAppointment

BEGIN SCHEDULES
# valid date ranges this tests populates the slot 1 tdv including the etag from the successful book, contact telecom is removed for happy path
BookAppointment_HappyPath TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch BundleIDsCorrelate AppointmentIsBooked AppointmentHasId 

BookAppointment_Basic TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointmentBasic ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch BundleIDsCorrelate AppointmentIsBooked AppointmentHasId 

BookAppointment_NotVerified TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_NotVerified ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch AppointmentIsBooked AppointmentHasId 

BookAppointment_NoNHSNumber TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_NoNHSNumber ResponseIsAppointmentExtracting1 IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch AppointmentIsBooked AppointmentHasId 

BookAppointment_SlotAlreadyBooked TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_SlotAlreadyBookedInitialBooking BookAppointment_SlotAlreadyBooked ResponseIsOperationOutcome  

BookAppointment_UnsupportedMediaType TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_UnsupportedMediaType ResponseIsOperationOutcome 

#
# two rank 1 contacts
BookAppointment_TwoRank1 TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_TwoRank1 ResponseIsOperationOutcome 

# no rank 1 contact BR-PAT-CON,RR-PAT-CON
BookAppointment_NoRank1 TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_NoRank1 ResponseIsOperationOutcome 

# rank 1 contact is not ONESELF
BookAppointment_Rank1NotOneself TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_Rank1NotOneself ResponseIsAppointment IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch AppointmentIsBooked AppointmentHasId

# UECABS-153 gzip encoding both ways
BookAppointment_HappyPathWithGzip TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_gzip ResponseIsAppointmentExtracting1 ResponseWasGzip IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch AppointmentIsBooked AppointmentHasId 
#
BookAppointment_WithResentRequestID TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment ResponseIsAppointmentExtracting1 BookAppointment_resend_rq_id ResponseIsOperationOutcome IssueCodeDuplicate IssueDetailsCodeConflict

BookAppointment_WithNoRequestID TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_no_rq_id ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest

BookAppointment_WithNonGUIDRequestID TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_non_guid_rq_id ResponseIsOperationOutcome IssueCodeValueOrInvalid IssueDetailsCodeBadRequest 

BookAppointment_WithResentBundleID TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment ResponseIsAppointmentExtracting1 BookAppointment_resend_bundle_id ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

BookAppointment_WithInvalidEventCode TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_invalid_event_code ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

BookAppointment_WithInvalidReasonCode TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_invalid_reason_code ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

BookAppointment_WithNoVersionID TESTS SFFSWithValidParameters_3_days_1 ResponseIsBundleExtracting1 BookAppointment_no_version_id ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

# May not be required
# GetBookingsForAPatient
#GetBookingsForAPatient TESTS GetBookingsForAPatient ResponseIsBundle

END SCHEDULES

BEGIN TESTS
BookAppointmentBasic SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/booking_request_basic.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200 SCAL BR-CONS-BOOK BR-PAT-REG"

AppointmentHasId CHAIN SYNC appt_has_id TEXT "Booked appointment has an allocated id element."
LocationIsWellFormed CHAIN SYNC location_is_well_formed TEXT "Location is well formed."

OutcomeSeverityIsError CHAIN SYNC severity_is_error TEXT "Operation Outcome severity is error." 
OutcomeCodeIsProcessing CHAIN SYNC code_is_processing TEXT "Operation Outcome code is Processing." 

OutcomeDetailsCodeIsProcessing CHAIN SYNC details_code_is_processing TEXT "Operation Outcome details code is Processing." 
OutcomeDetailsSystemIsIssueType CHAIN SYNC details_system_is_issue-type TEXT "Operation Outcome details system is http://hl7.org/fhir/issue-type." 
OutcomeDetailsDisplayIsProcessingFailure CHAIN SYNC details_display_is_processing_failure TEXT "Operation Outcome details display is Processing Failure." 
OutcomeDiagnosticsIsSlotNoLongerAvailable CHAIN SYNC diagnostics_is_slot_no_longer_available TEXT "Operation Outcome diagnostics is Slot no longer available."

BookAppointment_NotVerified SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_not_verified.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200"
#
# slot already booked scenario 15
BookAppointment_SlotAlreadyBookedInitialBooking SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200"
BookAppointment_SlotAlreadyBooked SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 409"

# unsupported media type 20 - content type is application/xml
BookAppointment_UnsupportedMediaType SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck415 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+unsupported_content+default_accept+integrity TEXT "HTTP Response must be HTTP 415"

BookAppointment_NoNHSNumber SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_and_nhs_no.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200 SCAL BR_PAT_UNREG BR-PAT-REG-NOT-VER"


BookAppointment_TwoRank1 SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_and_change_rank.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 400"

BookAppointment_NoRank1 SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_and_rank1.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"

BookAppointment_Rank1NotOneself SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_and_change_relationship_to_brother.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 200"

BookAppointment_gzip SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+content_gzip+accept_gzip+integrity TEXT "HTTP Response must be HTTP 200"

BookAppointment_resend_rq_id SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 409"

BookAppointment_no_rq_id SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+default_content TEXT "HTTP Response must be HTTP 400"

BookAppointment_non_guid_rq_id SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+default_content+nonguid_integrity TEXT "HTTP Response must be HTTP 400"

BookAppointment_resend_bundle_id SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_resend_bundleid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 400"

BookAppointment_invalid_event_code SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_invalidate_event_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 400"

BookAppointment_invalid_reason_code SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_invalidate_reason_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 400"

BookAppointment_no_version_id SEND_TKW book_appointment_slot1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/remove_appt_id_and_versionid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_content+default_accept+integrity TEXT "HTTP Response must be HTTP 400"

# search bookins for a patient
GetBookingsForAPatient SEND_TKW empty_file TO __TO_ENDPOINT__/Appointment?https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%3A9999999999 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC ok WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+integrity TEXT "HTTP Response must be HTTP 200"
END TESTS

BEGIN PASSFAIL
appt_has_id synchronousxpath /fhir:Bundle/fhir:entry/fhir:resource/fhir:Appointment/fhir:id/@value exists
location_is_well_formed httpheadercheck Location matches "^https://.+/Appointment/.+$"

severity_is_error synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:severity/@value matches "^error$"
code_is_processing synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:code/@value matches "^processing$"

details_system_is_issue-type synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:details/fhir:coding/fhir:system/@value matches "^http://hl7.org/fhir/issue-type$"
details_code_is_processing synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:details/fhir:coding/fhir:code/@value matches "^processing$"
details_display_is_processing_failure synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:details/fhir:coding/fhir:display/@value matches "^Processing Failure$"

diagnostics_is_slot_no_longer_available synchronousxpath /fhir:OperationOutcome/fhir:issue/fhir:diagnostics/@value matches "^Slot no longer available$"

END PASSFAIL
