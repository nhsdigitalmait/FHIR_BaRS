#APPLICATION 6
# Use Case 
# CAD to CAD request 04 (Out of Area Use Case)
# BaRS_ReferralRequest tstp file
#
SCRIPT BaRS_CADtoCAD_ReferralRequest

BEGIN SCHEDULES

#SCENARIO1
ReferralRequest_CADtoCAD_json_Scenario_1 TESTS ReferralRequest_04_Test_json_accept_6_OOA_1_1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_json_accept_6_OOA_1_2 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate ReferralRequest_04_Test_json_accept_6_OOA_1_3 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate ReferralRequest_04_Test_json_accept_6_OOA_1_4 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate
#SCENARIO2
ReferralRequest_CADtoCAD_json_Scenario_2 TESTS ReferralRequest_04_Test_json_accept_6_OOA_2_1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_json_accept_6_OOA_2_2 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate ReferralRequest_04_Test_json_accept_6_OOA_2_3 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate
#SCENARIO3
ReferralRequest_CADtoCAD_json_Scenario_3 TESTS ReferralRequest_04_Test_json_accept_6_OOA_3_1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_json_accept_6_OOA_3_2 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

###NBRS-3330
ReferralRequest_CADtoCAD_GetMessageDefinition_xml_accept TESTS MessageDefinitionTest_xml_accept ResponseIsXml ResponseIsBundle SearchCountIsGreaterThanZero ResponseIsMessageDefinition messagedefinition_hasusecasecategory messagedefinition_CADtoCAD_usecasecode_a6t1 messagedefinition_CADtoCAD_usecasecode_a6t2 messagedefinition_CADtoCAD_usecasecode_a6t3 messagedefinition_CADtoCAD_procedure_reference messagedefinition_CADtoCAD_communication_reference
ReferralRequest_CADtoCAD_GetMessageDefinition_json_accept TESTS MessageDefinitionTest_json_accept ResponseIsJson ResponseIsBundle SearchCountIsGreaterThanZero ResponseIsMessageDefinition messagedefinition_hasusecasecategory messagedefinition_CADtoCAD_usecasecode_a6t1 messagedefinition_CADtoCAD_usecasecode_a6t2 messagedefinition_CADtoCAD_usecasecode_a6t3 messagedefinition_CADtoCAD_procedure_reference messagedefinition_CADtoCAD_communication_reference
###

# full referral request 04 999 to CAS
ReferralRequest_CADtoCAD_xml_accept TESTS ReferralRequest_04_Test_xml_accept ResponseIsXml IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

ReferralRequest_CADtoCAD_json_accept TESTS ReferralRequest_04_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate
#
# basic request
ReferralRequest_CADtoCAD_Basic TESTS ReferralRequest_04_Test_Basic ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

# no nhs no 
ReferralRequest_CADtoCAD_NoNhsNo TESTS ReferralRequest_04_Test_NoNhsNo ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate

# rank 1 contact is not ONESELF
ReferralRequest_CADtoCAD_Rank1NotOneself TESTS ReferralRequest_04_Test_Rank1NotOneself ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate

ReferralRequest_CADtoCAD_NoRank1 TESTS ReferralRequest_04_Test_NoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome
ReferralRequest_CADtoCAD_TwoRank1 TESTS ReferralRequest_04_Test_TwoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

ReferralRequest_CADtoCAD_WrongMethod TESTS ReferralRequest_04_Test_WrongMethod ResponseIsJson ResponseIsOperationOutcome IssueCodeNotSupported IssueDetailsCodeMethodNotAllowed

ReferralRequest_CADtoCAD_NoVersionID TESTS ReferralRequest_04_Test_NoVersionID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

# Update
ReferralRequest_CADtoCAD_Update TESTS ReferralRequest_04_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_Update ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate


# invalid last updated
ReferralRequest_CADtoCAD_Update_InvalidLastUpdated TESTS ReferralRequest_04_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_Update_InvalidLastUpdated ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome IssueCodeConflict IssueDetailsCodeConflict

# Cancel
ReferralRequest_CADtoCAD_Cancel TESTS ReferralRequest_04_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_Cancel ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate

ReferralRequest_CADtoCAD_Cancel_InvalidStatus TESTS ReferralRequest_04_Test_json_accept ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_Cancel_InvalidStatus ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_Cancel_ChangeCategory TESTS ReferralRequest_04_Test_json_accept ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_Cancel_ChangeCategory ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_Ignore_IDs TESTS ReferralRequest_04_Test_IgnoreIDs ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate ResponseIsNotEchoingIDs 

ReferralRequest_CADtoCAD_WithResentRequestID TESTS ReferralRequest_04_Test_json_accept ResponseIsJson ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_ResentRequestID ResponseIsOperationOutcome  IssueCodeDuplicate IssueDetailsCodeConflict

ReferralRequest_CADtoCAD_WithNoRequestID TESTS ReferralRequest_04_Test_NoRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_WithNonGUIDRequestID TESTS ReferralRequest_04_Test_NonGUIDRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeValueOrInvalid IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_WithResentBundleID TESTS ReferralRequest_04_Test_json_accept ResponseIsJson ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_04_Test_ResentBundleID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest 

ReferralRequest_CADtoCAD_NotDirectCare TESTS ReferralRequest_04_Test_NotDirectCare ResponseIsJson ResponseIsOperationOutcome

ReferralRequest_CADtoCAD_InvalidEventCode TESTS ReferralRequest_04_Test_InvalidEventCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_InvalidReasonCode TESTS ReferralRequest_04_Test_InvalidReasonCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_CarePlanNotComplete TESTS ReferralRequest_04_Test_CarePlanNotComplete ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_EncounterChanged TESTS ReferralRequest_04_Test_EncounterChanged ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_CADtoCAD_ChangeCategory TESTS ReferralRequest_04_Test_ChangeCategory ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_04_Test_NoLocation TESTS ReferralRequest_04_Test_NoLocation ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

END SCHEDULES

BEGIN TESTS
# 04 CAD to CAD Out Of Area
# new SR status = active, SR Category = referral, Encounter Status = triaged/completed

messagedefinition_CADtoCAD_usecasecode_a6t1 CHAIN SYNC messagedefinition_includes_a6t1 TEXT "Use case category code a6t1 is present"
messagedefinition_CADtoCAD_usecasecode_a6t2 CHAIN SYNC messagedefinition_includes_a6t2 TEXT "Use case category code a6t2 is present"
messagedefinition_CADtoCAD_usecasecode_a6t3 CHAIN SYNC messagedefinition_includes_a6t3 TEXT "Use case category code a6t3 is present"
messagedefinition_CADtoCAD_procedure_reference CHAIN SYNC messagedefinition_includes_procedure TEXT "Procedure profile reference is present"
messagedefinition_CADtoCAD_communication_reference CHAIN SYNC messagedefinition_includes_communication TEXT "Communication profile reference is present"



ReferralRequest_CADtoCAD_MessageDefinitionTest_xml_accept SEND_TKW empty_file TO __TO_ENDPOINT__/MessageDefinition?context=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fdos-service-id%7C2000070514 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC ok WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-MSG-DEF-RESO"
ReferralRequest_CADtoCAD_MessageDefinitionTest_json_accept SEND_TKW empty_file TO __TO_ENDPOINT__/MessageDefinition?context=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fdos-service-id%7C2000070514 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC ok WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-MSG-DEF-RESO"

ReferralRequest_CADtoCAD_MessageDefinitionTest_no_context SEND_TKW empty_file TO __TO_ENDPOINT__/MessageDefinition FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+integrity TEXT "HTTP Response must be HTTP 400"
ReferralRequest_CADtoCAD_MessageDefinitionTest_context_does_not_exist SEND_TKW empty_file TO __TO_ENDPOINT__/MessageDefinition?context=http%3A%2F%2Ffhir.nhs.uk%2FId%2Fdos-service-id%7C99999999999999 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck404 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+integrity TEXT "HTTP Response must be HTTP 404"
ReferralRequest_CADtoCAD_MessageDefinition_context_is_invalid SEND_TKW empty_file TO __TO_ENDPOINT__/MessageDefinition?context=XXXXXXX FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+integrity TEXT "HTTP Response must be HTTP 400"

#Response Test
#ReferralRequest_04_Test_xml_accept SEND_TKW referral_request_04 TO __TO_ENDPOINT_A__/$process-message FROM  __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT_A__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_referral_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

#FullReferralRequest
ReferralRequest_04_Test_xml_accept SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_referral_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_04_Test_json_accept SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_referral_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

#SCENARIO1
ReferralRequest_04_Test_json_accept_6_OOA_1_1 SEND_TKW referral_request_6_OOA_1 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_1_1.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_1_2 SEND_TKW referral_request_6_OOA_1_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_1_2.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_1_3 SEND_TKW referral_request_6_OOA_1_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_1_3.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_1_4 SEND_TKW referral_request_6_OOA_1_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_1_4.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

#SCENARIO2
ReferralRequest_04_Test_json_accept_6_OOA_2_1 SEND_TKW referral_request_6_OOA_2 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_2_1.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_2_2 SEND_TKW referral_request_6_OOA_2_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_2_2.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_2_3 SEND_TKW referral_request_6_OOA_2_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_2_3.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

#SCENARIO3
ReferralRequest_04_Test_json_accept_6_OOA_3_1 SEND_TKW referral_request_6_OOA_3 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_3_1.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_04_Test_json_accept_6_OOA_3_2 SEND_TKW referral_request_6_OOA_3_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/6_OOA_3_2.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

# basic request
ReferralRequest_04_Test_Basic SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_basic.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_04_Test_NotVerified SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_verified.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG-NOT-VERRR-PAT-UNREG"
ReferralRequest_04_Test_NoNhsNo SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_nhs_no.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200RR-PAT-REG-NOT-VER RR-PAT-UNREG"
ReferralRequest_04_Test_Rank1NotOneself SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_relationship_to_brother.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_04_Test_NoRank1 SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_rank1.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 HTTP SCAL BR-PAT-CON, RR-PAT-CON"

ReferralRequest_04_Test_TwoRank1 SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_rank.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 HTTP SCAL BR-PAT-CON, RR-PAT-CON"

ReferralRequest_04_Test_IgnoreIDs SEND_TKW referral_request_04_no_ds TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_leave_ids.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

# update, ReasonCode = update, SR status = active, Encounter status = triaged
ReferralRequest_04_Test_Update SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_04_Test_Update_InvalidLastUpdated SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request_invalid_last_updated.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 409"

# cancel, ReasonCode = update, SR status = revoked, Encounter status = triaged
ReferralRequest_04_Test_Cancel SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+cancel_cr_id TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_04_Test_Cancel_InvalidStatus SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request_invalid_status.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+cancel_cr_id TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_Cancel_ChangeCategory SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request_change_category.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+cancel_cr_id TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_ResentRequestID SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 409"

ReferralRequest_04_Test_NotDirectCare SEND_TKW referral_request_04_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_direct_care.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_NoRequestID SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_NonGUIDRequestID SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+nonguid_integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_ResentBundleID SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_resend_bundleid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_InvalidEventCode SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_event_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_InvalidReasonCode SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_reason_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_WrongMethod SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck405 WITH_PROPERTYSET base+webservices+put WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 405"

ReferralRequest_04_Test_NoVersionID SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_versionid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_CarePlanNotComplete SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_change_careplan_status_active.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_EncounterChanged SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_change_encounter_status.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_ChangeCategory SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_change_category.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_04_Test_NoLocation SEND_TKW referral_request_04 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_location.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

END TESTS

BEGIN MESSAGES
referral_request_6_OOA_1 USING 6_OOA_1_template WITH referral_service_request_ds ID s1
referral_request_6_OOA_2 USING 6_OOA_2_template WITH referral_service_request_ds ID s1
referral_request_6_OOA_3 USING 6_OOA_3_template WITH referral_service_request_ds ID s1

referral_request_6_OOA_1_extracted USING 6_OOA_1_template WITH referral_service_request_ds ID s1
referral_request_6_OOA_2_extracted USING 6_OOA_2_template WITH referral_service_request_ds ID s1
referral_request_6_OOA_3_extracted USING 6_OOA_3_template WITH referral_service_request_ds ID s1

referral_request_04_extracted USING referral_request_04_template WITH referral_service_request_ds ID s1
referral_request_04_no_ds USING referral_request_04_template WITH NULL
END MESSAGES

BEGIN PASSFAIL

messagedefinition_includes_procedure synchronousxpath //fhir:MessageDefinition/fhir:focus/fhir:profile[@value='https://fhir.hl7.org.uk/StructureDefinition/UKCore-Procedure'] exists
messagedefinition_includes_communication synchronousxpath //fhir:MessageDefinition/fhir:focus/fhir:profile[@value='https://fhir.hl7.org.uk/StructureDefinition/UKCore-Communication'] exists
messagedefinition_includes_a6t1 synchronousxpath //fhir:MessageDefinition/fhir:useContext/fhir:code/fhir:code[@value='a6t1'] exists
messagedefinition_includes_a6t2 synchronousxpath //fhir:MessageDefinition/fhir:useContext/fhir:code/fhir:code[@value='a6t2'] exists
messagedefinition_includes_a6t3 synchronousxpath //fhir:MessageDefinition/fhir:useContext/fhir:code/fhir:code[@value='a6t3'] exists

referralrequest_usecase_includes_a6t1 synchronousxpath //fhir:category/fhir:coding[fhir:system/@value='https://fhir.nhs.uk/CodeSystem/usecases-categories-bars']/fhir:code[@value='a6t1'] exists
referralrequest_servicerequest_status_revoked synchronousxpath //fhir:ServiceRequest[fhir:status/@value='revoked'] exists
referralrequest_encounter_status_cancelled synchronousxpath //fhir:Encounter[fhir:status/@value='cancelled'] exists
referralrequest_location_meta_exists synchronousxpath //fhir:Bundle/fhir:entry/fhir:resource/fhir:Location/fhir:meta exists 
referralrequest_location_address_exists synchronousxpath //fhir:Bundle/fhir:entry/fhir:resource/fhir:Location/fhir:address exists 
referralrequest_location_position_exists synchronousxpath //fhir:Bundle/fhir:entry/fhir:resource/fhir:Location/fhir:position exists 
referralrequest_location_extension_exists synchronousxpath //fhir:Bundle/fhir:entry/fhir:resource/fhir:Location/fhir:extension exists 
referralrequest_safety_exists synchronousxpath //fhir:Bundle/fhir:entry/fhir:resource/fhir:Flag exists 


END PASSFAIL
