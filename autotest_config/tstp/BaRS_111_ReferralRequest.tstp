#
# Use Case 
# 111 to ED request 01
# BaRS_111_ReferralRequest tstp file
#
SCRIPT BaRS_111_ReferralRequest

BEGIN SCHEDULES
# full referral request 01 111 to ED
ReferralRequest_111toED_xml_accept TESTS ReferralRequest_01_Test_xml_accept ResponseIsXml IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

ReferralRequest_111toED_json_accept TESTS ReferralRequest_01_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

# basic request
ReferralRequest_111toED_Basic TESTS ReferralRequest_01_Test_Basic ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

# no nhs no This was changed to expect a 200 ok after a verbal request from Carl D at the catch up on Thursday 29 Oct 2022
ReferralRequest_111toED_NoNhsNo TESTS ReferralRequest_01_Test_NoNhsNo ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID BundleIDsCorrelate

# rank 1 contact is not ONESELF
ReferralRequest_111toED_Rank1NotOneself TESTS ReferralRequest_01_Test_Rank1NotOneself ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle

ReferralRequest_111toED_NoRank1 TESTS ReferralRequest_01_Test_NoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome
ReferralRequest_111toED_TwoRank1 TESTS ReferralRequest_01_Test_TwoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

ReferralRequest_111toED_WrongMethod TESTS ReferralRequest_01_Test_WrongMethod ResponseIsJson ResponseIsOperationOutcome IssueCodeNotSupported IssueDetailsCodeMethodNotAllowed

ReferralRequest_111toED_NoVersionID TESTS ReferralRequest_01_Test_NoVersionID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

# Update
## backlog states that there is not 111 to ED update only a cancel

#ReferralRequest_111toED_Update TESTS ReferralRequest_01_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_01_Test_Update ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID

# Cancel
ReferralRequest_111toED_Cancel TESTS ReferralRequest_01_Test_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_01_Test_Cancel ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate

ReferralRequest_111toED_Ignore_IDs TESTS ReferralRequest_01_Test_IgnoreIDs ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate ResponseIsNotEchoingIDs

ReferralRequest_111toED_WithResentRequestID TESTS ReferralRequest_01_Test_json_accept ResponseIsJson ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_01_Test_ResentRequestID ResponseIsOperationOutcome IssueCodeDuplicate IssueDetailsCodeConflict

ReferralRequest_111toED_NotDirectCare TESTS ReferralRequest_01_Test_NotDirectCare ResponseIsJson ResponseIsOperationOutcome

ReferralRequest_111toED_WithNoRequestID TESTS ReferralRequest_01_Test_NoRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest

ReferralRequest_111toED_WithNonGUIDRequestID TESTS ReferralRequest_01_Test_NonGUIDRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeValueOrInvalid IssueDetailsCodeBadRequest

ReferralRequest_111toED_WithResentBundleID TESTS ReferralRequest_01_Test_json_accept ResponseIsJson ResponseIsBundle_ExtractingReferralServiceID ReferralRequest_01_Test_ResentBundleID ResponseIsJson ResponseIsOperationOutcome  IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_111toED_InvalidEventCode TESTS ReferralRequest_01_Test_InvalidEventCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ReferralRequest_111toED_InvalidReasonCode TESTS ReferralRequest_01_Test_InvalidReasonCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

# Error Scenarios for GET /ServiceRequest
GetServiceRequestPathIdMissing TESTS GetServiceRequestPathIdMissing ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest
GetServiceRequestPathIdInvalid TESTS GetServiceRequestPathIdInvalid ResponseIsOperationOutcome IssueCodeValue IssueDetailsCodeBadRequest
GetServiceRequestPathIdNotFound TESTS GetServiceRequestPathIdNotFound ResponseIsOperationOutcome IssueCodeNotFound
GetServiceRequestPatientParameterMissing TESTS GetServiceRequestPatientParameterMissing ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest
GetServiceRequestPatientParameterInvalid TESTS GetServiceRequestPatientParameterInvalid ResponseIsOperationOutcome IssueCodeValue IssueDetailsCodeSendOrRecBadRequest

END SCHEDULES

BEGIN TESTS
# 01 111 to ED
# new SR status = active, SR Category = referral, Encounter Status = triaged/completed
ReferralRequest_01_Test_xml_accept SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ReferralRequest_01_Test_json_accept SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

# Basic Referral request
ReferralRequest_01_Test_Basic SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_basic.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_01_Test_NotVerified SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_verified.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG-NOT-VER RR-PAT-UNREG"
ReferralRequest_01_Test_NoNhsNo SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_nhs_no.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200"
ReferralRequest_01_Test_Rank1NotOneself SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_relationship_to_brother.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME"

ReferralRequest_01_Test_NoRank1 SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_rank1.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"
ReferralRequest_01_Test_TwoRank1 SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_rank.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"

# update, ReasonCode = update, SR status = active, Encounter status = triaged
ReferralRequest_01_Test_Update SEND_TKW referral_request_01_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

# cancel, ReasonCode = update, SR status = revoked, Encounter status = triaged
ReferralRequest_01_Test_Cancel SEND_TKW referral_request_01_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_01_Test_IgnoreIDs SEND_TKW referral_request_01_no_ds TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_leave_ids.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ReferralRequest_01_Test_ResentRequestID SEND_TKW referral_request_01_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 409"

ReferralRequest_01_Test_NotDirectCare SEND_TKW referral_request_01_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_direct_care.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_NoRequestID SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_NonGUIDRequestID SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+nonguid_integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_ResentBundleID SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_resend_bundleid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_InvalidEventCode SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_event_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_InvalidReasonCode SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_reason_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ReferralRequest_01_Test_WrongMethod SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck405 WITH_PROPERTYSET base+webservices+put WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 405"

ReferralRequest_01_Test_NoVersionID SEND_TKW referral_request_01 TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_versionid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

GetServiceRequestPathIdMissing SEND_TKW empty_file TO __TO_ENDPOINT__/ServiceRequest/ FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 400"

GetServiceRequestPathIdInvalid SEND_TKW empty_file TO __TO_ENDPOINT__/ServiceRequest/XXXXXXXXX FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 400"

GetServiceRequestPathIdNotFound SEND_TKW empty_file TO __TO_ENDPOINT__/ServiceRequest/95e58add-0b10-4a8c-817c-2729eb0cab75 FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck404 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 404"

GetServiceRequestPatientParameterMissing SEND_TKW empty_file TO __TO_ENDPOINT__/ServiceRequest?https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 400"

GetServiceRequestPatientParameterInvalid SEND_TKW empty_file TO __TO_ENDPOINT__/ServiceRequest?https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7CXXXXXX __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+get WITH_HTTPHEADERS credentials+default_accept+Oauth2AccessToken+integrity TEXT "HTTP Response must be HTTP 400"

END TESTS

BEGIN MESSAGES
referral_request_01_extracted USING referral_request_01_template WITH referral_service_request_ds ID s1
referral_request_01_no_ds USING referral_request_01_template WITH NULL
END MESSAGES
