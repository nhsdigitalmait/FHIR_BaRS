#
# BaRS_ValidationRequest tstp file
#
SCRIPT BaRS_ValidationRequest

BEGIN SCHEDULES
ValidationRequest_xml_accept TESTS ValidationRequestTest_xml_accept ResponseIsXml ResponseIsBundle_ExtractingValidationServiceID IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch
ValidationRequest_json_accept TESTS ValidationRequestTest_json_accept ResponseIsJson ResponseIsBundle_ExtractingValidationServiceID IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch
ValidationRequestUpdate TESTS ValidationRequestUpdateTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch
ValidationRequestCancel TESTS ValidationRequestCancelTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch
END SCHEDULES

BEGIN TESTS
# new, ReasonCode = new, SR status = active,  SR Category = validation, Encounter status = triaged
ValidationRequestTest_xml_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200"
ValidationRequestTest_json_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

# update, ReasonCode = update, SR status = active,  SR Category = validation, Encounter status = triaged
ValidationRequestUpdateTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

# cancel, ReasonCode = update, SR status = revoked,  SR Category = validation, Encounter status = triaged
ValidationRequestCancelTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

ResponseIsBundle_ExtractingValidationServiceID CHAIN SYNC responseisbundle_extracting_validation_serviceid TEXT "Response is a bundle"

END TESTS

BEGIN MESSAGES
validation_request USING validation_request_template WITH validation_service_request
validation_request_extracted USING validation_request_template WITH validation_service_request ID sid1
END MESSAGES

BEGIN TEMPLATES
validation_request_template __TKWROOT__/config/FHIR_BaRS/autotest_config/requests/validation_request___TO_SERVICE__.xml
END TEMPLATES

BEGIN PASSFAIL
responseisbundle_extracting_validation_serviceid synchronousxpath /fhir:Bundle exists EXTRACTOR validation_service_request_extractor 
END PASSFAIL

BEGIN EXTRACTORS
validation_service_request_extractor xpathextractor __TKWROOT__/config/FHIR_BaRS/autotest_config/extractor_configs/validation_service_request.cfg
END EXTRACTORS

BEGIN DATASOURCES
validation_service_request circularwritabletdv __TKWROOT__/config/FHIR_BaRS/autotest_config/extractor_configs/validation_service_request.tdv
END DATASOURCES
