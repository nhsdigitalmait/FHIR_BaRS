#
# BaRS_ValidationRequest tstp file Use Case 999 to CAS
# Use Case 999 to CAS
#
SCRIPT BaRS_ValidationRequest

BEGIN SCHEDULES
ValidationRequest_xml_accept TESTS ValidationRequestTest_xml_accept ResponseIsXml IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID
ValidationRequest_json_accept TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID

# verified nhs no 
ValidationRequest_Verified TESTS ValidationRequestTest_Verified ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# no nhs no 
ValidationRequest_NoNhsNo TESTS ValidationRequestTest_NoNhsNo ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# rank 1 contact is not ONESELF
ValidationRequest_Rank1NotOneself TESTS ValidationRequestTest_Rank1NotOneself ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle

# contact rank
ValidationRequest_NoRank1 TESTS ValidationRequestTest_NoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

ValidationRequest_TwoRank1 TESTS ValidationRequestTest_TwoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

# scene safety unsafe SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO
ValidationRequest_SS_Unsafe TESTS ValidationRequestTest_SS_Unsafe ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID

# scene safety unknown SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO
ValidationRequest_SS_Unknown TESTS ValidationRequestTest_SS_Unknown ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID


ValidationRequestUpdate TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID ValidationRequestUpdateTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID
ValidationRequestCancel TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID ValidationRequestCancelTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID

ValidationRequest_Ignore_IDs TESTS ValidationRequestTest_ignore_ids ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle ResponseIsNotEchoingIDs
END SCHEDULES

BEGIN TESTS
# new, ReasonCode = new, SR status = active,  SR Category = validation, Encounter status = triaged
ValidationRequestTest_xml_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200"
ValidationRequestTest_json_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

ValidationRequestTest_Verified SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_verified.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"
ValidationRequestTest_NoNhsNo SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_nhs_no.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"
ValidationRequestTest_Rank1NotOneself SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_relationship_to_brother.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"
ValidationRequestTest_NoRank1 SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_rank1.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"

ValidationRequestTest_TwoRank1 SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_rank.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"

ValidationRequestTest_SS_Unsafe SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_ss_unsafe.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO"

ValidationRequestTest_SS_Unknown SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_ss_unknown.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO"
#
# update, ReasonCode = update, SR status = active,  SR Category = validation, Encounter status = triaged
ValidationRequestUpdateTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

# cancel, ReasonCode = update, SR status = revoked,  SR Category = validation, Encounter status = triaged
ValidationRequestCancelTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

ValidationRequestTest_ignore_ids SEND_TKW validation_request_no_ds TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_leave_ids.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200"

ResponseIsBundle_ExtractingValidationServiceID CHAIN SYNC responseisbundle_extracting_validation_serviceid TEXT "Response is a bundle"

END TESTS

BEGIN MESSAGES
validation_request USING validation_request_template WITH validation_service_request_ds
validation_request_extracted USING validation_request_template WITH validation_service_request_ds ID sid1
validation_request_no_ds USING validation_request_template WITH NULL
END MESSAGES

BEGIN TEMPLATES
validation_request_template __TKWROOT__/config/FHIR_BaRS/autotest_config/requests/validation_request___TO_SERVICE__.xml
END TEMPLATES

BEGIN PASSFAIL
responseisbundle_extracting_validation_serviceid synchronousxpath /fhir:Bundle exists EXTRACTOR validation_service_request_extractor 
END PASSFAIL

BEGIN EXTRACTORS
validation_service_request_extractor xpathextractor __TKWROOT__/config/FHIR_BaRS/autotest_config/extractor_configs/validation_service_request.cfg

END EXTRACTORS

BEGIN DATASOURCES
validation_service_request_ds circularwritabletdv __TKWROOT__/config/FHIR_BaRS/autotest_config/extractor_configs/validation_service_request.tdv

END DATASOURCES
