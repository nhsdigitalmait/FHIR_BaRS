#
# BaRS_ValidationRequest tstp file Use Case 999 to CAS
# Use Case 999 to CAS
#
SCRIPT BaRS_ValidationRequest

BEGIN SCHEDULES

ValidationRequest_GetMessageDefinition_xml_accept TESTS MessageDefinitionTest_xml_accept ResponseIsXml ResponseIsBundle SearchCountIsGreaterThanZero ResponseIsMessageDefinition messagedefinition_hasusecasecategory ValidationRequest_usecasecode
ValidationRequest_GetMessageDefinition_json_accept TESTS MessageDefinitionTest_json_accept ResponseIsJson ResponseIsBundle SearchCountIsGreaterThanZero ResponseIsMessageDefinition messagedefinition_hasusecasecategory ValidationRequest_usecasecode


ValidationRequest_xml_accept TESTS ValidationRequestTest_xml_accept ResponseIsXml IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate
ValidationRequest_json_accept TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

# Basic test
ValidationRequest_Basic TESTS ValidationRequestTest_Basic ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

# no nhs no 
ValidationRequest_NoNhsNo TESTS ValidationRequestTest_NoNhsNo ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate
# rank 1 contact is not ONESELF
ValidationRequest_Rank1NotOneself TESTS ValidationRequestTest_Rank1NotOneself ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate

# contact rank
ValidationRequest_NoRank1 TESTS ValidationRequestTest_NoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

ValidationRequest_TwoRank1 TESTS ValidationRequestTest_TwoRank1 ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

# scene safety unsafe SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO
ValidationRequest_SS_Unsafe TESTS ValidationRequestTest_SS_Unsafe ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

# scene safety unknown SCAL RS-REC_SCENE-INFO, RR-REC-SCENE-INFO
ValidationRequest_SS_Unknown TESTS ValidationRequestTest_SS_Unknown ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

# Start of Address Schedules
# from the matrix
# see https://nhsd-confluence.digital.nhs.uk/pages/viewpage.action?spaceKey=PAAB&title=Message+content+for+Address+Matrix
# 1. UPRN + Address
ValidationRequest_Location_UPRN_Address TESTS ValidationRequestTest_UPRN_Address ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 2. Address
ValidationRequest_Location_Address TESTS ValidationRequestTest_Address ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 3. E/N
ValidationRequest_Location_EN TESTS ValidationRequestTest_EN ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 4. UPRN
ValidationRequest_Location_UPRN TESTS ValidationRequestTest_UPRN ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 5. UPRN + Address + E/N + Pos (LL) DN how does this differ from a full request - it doesn't
ValidationRequest_Location_UPRN_Address_EN_LL TESTS ValidationRequestTest_UPRN_Address_EN_LL ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 6. UPRN + Address + E/N - DN This already exists as a transform elsewhere - CHECK 
ValidationRequest_Location_UPRN_Address_EN TESTS ValidationRequestTest_UPRN_Address_EN ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 7. UPRN + Address + E/N + W3W
ValidationRequest_Location_UPRN_Address_EN_W3W TESTS ValidationRequestTest_UPRN_Address_EN_W3W ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
#
# 8. UPRN + Address + LL
ValidationRequest_Location_UPRN_Address_LL TESTS ValidationRequestTest_UPRN_Address_LL ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 9. Pos (LL)
ValidationRequest_Location_LL TESTS ValidationRequestTest_LL ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
# 10. W3W
ValidationRequest_Location_W3W TESTS ValidationRequestTest_W3W ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle
#
# No location SCAL RR-REC-INCID-INFO
ValidationRequest_NoLocation TESTS ValidationRequestTest_NoLocation ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

# No UPRN SCAL RR-INFO-LOC-UPRN Postcode Address E/N Position
ValidationRequest_NoUPRN TESTS ValidationRequestTest_NoUPRN ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome
#
# No Location address or postcode or eastings/northings SCAL RR-INFO-LOC-EN UPRN + Position
ValidationRequest_NoLocationAddressPostcodeEastingsNorthings TESTS ValidationRequestTest_NoLocationAddressPostcodeEastingsNorthings ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome

# End of Address Schedules

ValidationRequest_WrongMethod TESTS ValidationRequest_Test_WrongMethod ResponseIsJson ResponseIsOperationOutcome IssueCodeNotSupported IssueDetailsCodeMethodNotAllowed

ValidationRequest_NoVersionID TESTS ValidationRequest_Test_NoVersionID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_Update TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID ValidationRequestUpdateTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

ValidationRequest_Update_InvalidLastUpdated TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID ValidationRequestUpdateTest_InvalidLastUpdated ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsOperationOutcome IssueCodeConflict IssueDetailsCodeConflict 

ValidationRequest_Cancel TESTS ValidationRequestTest_json_accept ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID ValidationRequestCancelTest ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate

ValidationRequest_Cancel_InvalidStatus TESTS ValidationRequestTest_json_accept ResponseIsBundle_ExtractingReferralServiceID ValidationRequestCancelTest_InvalidStatus ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_Ignore_IDs TESTS ValidationRequestTest_ignore_ids ResponseIsJson IntegrityRequestIDHeaderIsPresent IntegrityCorrelationIDHeaderIsPresent IntegrityRequestIDHeadersMatch IntegrityCorrelationIDHeadersMatch ResponseIsBundle BundleIDsCorrelate ResponseIsNotEchoingIDs 

ValidationRequest_WithResentRequestID TESTS ValidationRequestTest_json_accept ResponseIsJson ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate ValidationRequestTest_ResentRequestID ResponseIsOperationOutcome  IssueCodeDuplicate IssueDetailsCodeConflict

ValidationRequest_NotDirectCare TESTS ValidationRequestTest_NotDirectCare ResponseIsJson ResponseIsOperationOutcome

ValidationRequest_WithNoRequestID TESTS ValidationRequestTest_NoRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeRequired IssueDetailsCodeBadRequest

ValidationRequest_WithNonGUIDRequestID TESTS ValidationRequestTest_NonGUIDRequestID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_WithResentBundleID TESTS ValidationRequestTest_json_accept ResponseIsJson ResponseIsBundle_ExtractingValidationServiceID BundleIDsCorrelate ValidationRequestTest_ResentBundleID ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_WithInvalidEventCode TESTS ValidationRequestTest_InvalidEventCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_WithInvalidReasonCode TESTS ValidationRequestTest_InvalidReasonCode ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_CarePlanNotActive TESTS ValidationRequestTest_CarePlanNotActive ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

ValidationRequest_EncounterChanged TESTS ValidationRequestTest_EncounterChanged ResponseIsJson ResponseIsOperationOutcome IssueCodeInvariant IssueDetailsCodeBadRequest

END SCHEDULES

BEGIN TESTS
# new, ReasonCode = new, SR status = active,  SR Category = validation, Encounter status = triaged

ValidationRequest_usecasecode CHAIN SYNC ValidationRequest_usecase_includes_a4t TEXT "Use case category code beginning a4t is present"

ValidationRequestTest_xml_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+xml_accept+xml_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"
ValidationRequestTest_json_accept SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ValidationRequestTest_Basic SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_basic_validation_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+json_accept+json_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-PAT-REG"

ValidationRequestTest_NotVerified SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_verified.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUMERR-PAT-REG-NOT-VER RR-PAT-UNREG"
ValidationRequestTest_NoNhsNo SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_nhs_no.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUMERR-PAT-REG-NOT-VER RR-PAT-UNREG"
ValidationRequestTest_Rank1NotOneself SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_relationship_to_brother.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 RR-PAT-REG"
ValidationRequestTest_NoRank1 SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_rank1.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON RR-PAT-REG"

ValidationRequestTest_TwoRank1 SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_change_rank.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL BR-PAT-CON, RR-PAT-CON"

ValidationRequestTest_SS_Unsafe SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_ss_unsafe.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RS-REC_SCENE-INFO, RR-REC-SCENE-INFO RR-PAT-REG"

ValidationRequestTest_SS_Unknown SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_ss_unknown.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RS-REC_SCENE-INFO, RR-REC-SCENE-INFO RR-PAT-REG"

# Start of Location Address Tests
# NB Full message includes  LocationExtension/UPRN, Postcode, Address, LocationExtension/(eastings and northings), position (longitude and latitude) ( +W3W ? )
# Matrix
# 1
ValidationRequestTest_UPRN_Address SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn_address.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 2
ValidationRequestTest_Address SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_address.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 3
ValidationRequestTest_EN SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_en.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 4
ValidationRequestTest_UPRN SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 5
ValidationRequestTest_UPRN_Address_EN_LL SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn_address_en_ll.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 6
ValidationRequestTest_UPRN_Address_EN SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn_address_en.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 7
ValidationRequestTest_UPRN_Address_EN_W3W SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn_address_en_w3w.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 8
ValidationRequestTest_UPRN_Address_LL SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_uprn_address_ll.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
# 9
ValidationRequestTest_LL SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_ll.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
#10 W3W
ValidationRequestTest_W3W SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_w3w.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-REC-INCID-INFO"
#
# No Location Fail 400
ValidationRequestTest_NoLocation SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_location.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL RR-REC-INCID-INFO"

# No UPRN Fail 400 ie Postcode + Address + E/N + Position
ValidationRequestTest_NoUPRN SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_UPRN.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL RR-INFO-LOC-UPRN"

# NoLocationAddressPostcodeEastingsNorthings Fail 400 ie UPRN + position
ValidationRequestTest_NoLocationAddressPostcodeEastingsNorthings SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_no_location_address_postcode_eastings_northings.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400 SCAL RR-INFO-LOC-EN"

# End of Location Address Tests

# update, ReasonCode = update, SR status = active,  SR Category = validation, Encounter status = triaged
ValidationRequestUpdateTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUME RR-SERV-REQ-UPDATE"

ValidationRequestUpdateTest_InvalidLastUpdated SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/update_service_request_invalid_last_updated.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 409"

# cancel, ReasonCode = update, SR status = revoked,  SR Category = validation, Encounter status = triaged
ValidationRequestCancelTest SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+cancel_cr_id TEXT "HTTP Response must be HTTP 200 SCAL RR-SERV-REQ-CONSUMERR-SERV-REQ-CANCEL"

ValidationRequestCancelTest_InvalidStatus SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/cancel_service_request_invalid_status.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+cancel_cr_id TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_ignore_ids SEND_TKW validation_request_no_ds TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_leave_ids.xslt APPLYPRETRANSFORMTO data SYNC ok WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 200 RR-SERV-REQ-CONSUM RR-PAT-REG"

ValidationRequestTest_ResentRequestID SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck409 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 409"

ValidationRequestTest_NotDirectCare SEND_TKW validation_request_extracted TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_not_direct_care.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+resent_rq_id TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_NoRequestID SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_NonGUIDRequestID SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+nonguid_integrity TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_ResentBundleID SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_resend_bundleid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_InvalidEventCode SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_event_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_InvalidReasonCode SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_invalidate_reason_code.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ValidationRequest_Test_WrongMethod SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck405 WITH_PROPERTYSET base+webservices+put WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 405"

ValidationRequest_Test_NoVersionID SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_and_remove_versionid.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_CarePlanNotActive SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_change_careplan_status_completed.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

ValidationRequestTest_EncounterChanged SEND_TKW validation_request TO __TO_ENDPOINT__/$process-message FROM __FROM_ENDPOINT__:__FROM_ENDPOINT_PORT__ PRETRANSFORM __TKWROOT__/config/FHIR_BaRS/autotest_config/transforms/create_service_request_change_encounter_status.xslt APPLYPRETRANSFORMTO data SYNC httpstatuscheck400 WITH_PROPERTYSET base+webservices+post WITH_HTTPHEADERS credentials+Oauth2AccessToken+default_accept+default_content+integrity  TEXT "HTTP Response must be HTTP 400"

END TESTS

BEGIN MESSAGES
validation_request_extracted USING validation_request_template WITH validation_service_request_ds ID s1
validation_request_no_ds USING validation_request_template WITH NULL
END MESSAGES

BEGIN PASSFAIL
ValidationRequest_usecase_includes_a4t synchronousxpath //fhir:useContext/fhir:code[fhir:system/@value='https://fhir.nhs.uk/CodeSystem/usecases-categories-bars']/fhir:code[starts-with(@value, 'a4t')] exists
END PASSFAIL
