# BaRS validator ruleset used by tkw simulator
# NHS Interoperability Toolkit
# 
# 
# 
# *****************************************************************************************

VALIDATION-RULESET-NAME FHIR BaRS Configuration Ruleset 
VALIDATION-RULESET-VERSION 0.1
VALIDATION-RULESET-TIMESTAMP April 2022
VALIDATION-RULESET-AUTHOR NHS Digital

#==========================================================================================

# get booking
VALIDATE urn:nhs:names:services:bars:fhir:rest:read:appointment
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers

# new referral request
VALIDATE urn:nhs:names:services:bars:fhir:messaging:new:servicerequest-request
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers
CHECK sub servicerequest_request_payload

# update/cancel referral request
VALIDATE urn:nhs:names:services:bars:fhir:messaging:update:servicerequest-request
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers
CHECK sub servicerequest_request_payload

# new referral response
VALIDATE urn:nhs:names:services:bars:fhir:messaging:new:servicerequest-response
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers
CHECK sub servicerequest_response_payload

# new referral response
VALIDATE urn:nhs:names:services:bars:fhir:messaging:update:servicerequest-response
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers
CHECK sub servicerequest_response_payload

# new booking request
VALIDATE urn:nhs:names:services:bars:fhir:messaging:new:booking-request
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers

# update booking request
VALIDATE urn:nhs:names:services:bars:fhir:messaging:update:booking-request
CHECK hapifhirvalidator
ANNOTATION "HAPI FHIR Validation"
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers
CHECK sub request_with_body_contains_headers

# get message definition
VALIDATE urn:nhs:names:services:bars:fhir:rest:read:messagedefinition
CHECK sub request_contains_required_headers
# optional headers not part of the api specification but required for tkw
CHECK sub request_contains_optional_headers

# get capability statement
VALIDATE urn:nhs:names:services:bars:fhir:rest:read:metadata
CHECK sub request_contains_required_headers
# optional headers not part of the api specification but required for tkw
CHECK sub request_contains_optional_headers

# get referral
VALIDATE urn:nhs:names:services:bars:fhir:rest:read:servicerequest
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers

# get slots
VALIDATE urn:nhs:names:services:bars:fhir:rest:search:slot
CHECK sub request_contains_required_headers
CHECK sub request_contains_optional_headers

#==========================================================================================
# check that the request contains the required headers

SUBSET request_contains_required_headers
CHECK http_header NHSD-Target-Identifier matches ^.+$
ANNOTATION "Required http header NHSD-Target-Identifier - RS-HTTP-HEAD or BS-HTTP-HEAD"
CHECK http_header X-Request-Id matches ^.+$
ANNOTATION "Required http header X-Request-Id - RS-HTTP-HEAD or BS-HTTP-HEAD"
CHECK http_header X-Correlation-Id matches ^.+$
ANNOTATION "Required http header X-Correlation-Id - RS-HTTP-HEAD or BS-HTTP-HEAD"

IF context_path notmatches ^.*_format.*$
THEN
	CHECK http_header Accept matches ^application/fhir\+xml$|^application/fhir\+json$|^application/fhir\+xml;charset=utf-8$|^application/fhir\+json;charset=utf-8$
	ANNOTATION "Accept http header is a valid MIME-type - RS-HTTP-HEAD or BS-HTTP-HEAD"
ENDIF

#==========================================================================================
# check that the request contains the optional headers

SUBSET request_contains_optional_headers
CHECK http_header NHSD-End-User-Organisation matches ^.+$
ANNOTATION "WARNING Optional http header NHSD-End-User-Organisation - RS-HTTP-HEAD or BS-HTTP-HEAD"
CHECK http_header NHSD-Requesting-Practitioner matches ^.+$
ANNOTATION "WARNING Optional http header NHSD-Requesting-Practitioner - RS-HTTP-HEAD or BS-HTTP-HEAD"
CHECK http_header NHSD-Requesting-Person matches ^.+$
ANNOTATION "WARNING Optional http header NHSD-Requesting-Person - RS-HTTP-HEAD or BS-HTTP-HEAD"
CHECK http_header NHSD-Requesting-Software matches ^.+$
ANNOTATION "WARNING Optional http header NHSD-Requesting-Software - RS-HTTP-HEAD or BS-HTTP-HEAD"

#==========================================================================================
# check that the request with a body contains the required headers

SUBSET request_with_body_contains_headers
CHECK http_header Content-type matches ^application/fhir\+xml$|^application/fhir\+json$|^application/fhir\+xml;charset=utf-8$|^application/fhir\+json;charset=utf-8$
ANNOTATION "Content-type http header is a valid MIME-type - RS-HTTP-HEAD or BS-HTTP-HEAD"

#==========================================================================================
# service request payload (request) must be a bundle  and include at least the required resources

SUBSET servicerequest_request_payload

CHECK xpathexists /fhir:Bundle
ANNOTATION "Service request payload be a Bundle - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:MessageHeader
ANNOTATION "Service request payload must include the MessageHeader resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:Patient
ANNOTATION "Service request payload must include the Patient resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:ServiceRequest
ANNOTATION "Service request payload must include the ServiceRequest resource - RS-PAYLOAD-SERV-REQ"

CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:Organization
ANNOTATION "Service request payload must include the Organization resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:PractitonerRole
ANNOTATION "Service request payload must include the PractitonerRole resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:Practitioner
ANNOTATION "Service request payload must include the Practitioner resource - RS-PAYLOAD-SERV-REQ"

#==========================================================================================
# service request payload (response) must be a bundle  and include at least the required resources

SUBSET servicerequest_response_payload

CHECK xpathexists /fhir:Bundle
ANNOTATION "Service request payload be a Bundle - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:MessageHeader
ANNOTATION "Service request payload must include the MessageHeader resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:Patient
ANNOTATION "Service request payload must include the Patient resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:ServiceRequest
ANNOTATION "Service request payload must include the ServiceRequest resource - RS-PAYLOAD-SERV-REQ"

CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:HealthcareService
ANNOTATION "Service request payload must include the HealthcareService resource - RS-PAYLOAD-SERV-REQ"
CHECK xpathexists /fhir:Bundle/fhir:entry/fhir:resource/fhir:Organization
ANNOTATION "Service request payload must include the Organization resource - RS-PAYLOAD-SERV-REQ"



